# Leads Backend

Production-ready backend API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–∞–º–∏, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –Ω–∞ Node.js + Express + PostgreSQL —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

## üöÄ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Runtime**: Node.js 18+
- **Framework**: Express.js
- **Language**: TypeScript
- **Database**: PostgreSQL + Prisma ORM
- **Authentication**: JWT (JSON Web Tokens)
- **Password Hashing**: bcryptjs
- **Validation**: Custom validators
- **Containerization**: Docker & Docker Compose

## üìã –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è

- Node.js 18+
- PostgreSQL 12+ –∏–ª–∏ Docker
- npm/yarn/pnpm

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

#### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd leads-backend
```

#### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
npm install
```

#### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cp .env.example .env
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Å –≤–∞—à–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:

```env
NODE_ENV=development
PORT=3000
DATABASE_URL=postgresql://username:password@localhost:5432/leads_db
JWT_SECRET=your_super_secret_jwt_key_change_in_production
JWT_EXPIRY=7d
BCRYPT_ROUNDS=10
```

#### 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
npm run prisma:generate
npm run prisma:migrate
```

#### 5. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Å –≥–æ—Ä—è—á–µ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π):

```bash
npm run dev
```

–ü—Ä–æ–¥–∞–∫—à–Ω —Å–±–æ—Ä–∫–∞:

```bash
npm run build
npm start
```

### üê≥ Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

#### 1. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

```bash
docker-compose up -d
```

–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç:
- PostgreSQL –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –ú–∏–≥—Ä–∞—Ü–∏–∏ Prisma
- Backend API —Å–µ—Ä–≤–µ—Ä

#### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

```bash
docker-compose ps
```

#### 3. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏

```bash
docker-compose logs -f backend
```

#### 4. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã

```bash
docker-compose down
```

## üìö API Endpoints

### Authentication

```
POST /api/auth/register      - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST /api/auth/login         - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
```

### Users

```
GET /api/users/profile       - –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/users               - –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

### Lead Types

```
POST /api/lead-types         - –°–æ–∑–¥–∞—Ç—å —Ç–∏–ø –ª–∏–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/lead-types/my       - –ü–æ–ª—É—á–∏—Ç—å –º–æ–∏ —Ç–∏–ø—ã –ª–∏–¥–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç auth)
PUT /api/lead-types/:id      - –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø –ª–∏–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç auth)
DELETE /api/lead-types/:id   - –£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –ª–∏–¥–∞ (—Ç—Ä–µ–±—É–µ—Ç auth)
```

### Leads

```
POST /api/leads              - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–∏–¥ (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/leads/my            - –ü–æ–ª—É—á–∏—Ç—å –º–æ–∏ –ª–∏–¥—ã (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/leads/catalog       - –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏–¥–æ–≤
GET /api/leads/search        - –ü–æ–∏—Å–∫ –ª–∏–¥–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É
GET /api/leads/:id/full      - –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–¥–µ (—Ç—Ä–µ–±—É–µ—Ç auth)
PUT /api/leads/:id/publish   - –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ª–∏–¥ (—Ç—Ä–µ–±—É–µ—Ç auth)
```

### Orders

```
POST /api/orders/:leadId     - –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/orders/my           - –ü–æ–ª—É—á–∏—Ç—å –º–æ–∏ –∑–∞–∫–∞–∑—ã (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/orders/:id          - –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ (—Ç—Ä–µ–±—É–µ—Ç auth)
```

### Payments

```
POST /api/payments/create/:orderId - –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/payments/:orderId         - –ü–æ–ª—É—á–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –ø–æ –∑–∞–∫–∞–∑—É (—Ç—Ä–µ–±—É–µ—Ç auth)
POST /api/payments/refund/:id      - –í–µ—Ä–Ω—É—Ç—å –ø–ª–∞—Ç–µ–∂ (—Ç—Ä–µ–±—É–µ—Ç auth)
POST /api/payments/webhook         - Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
```

### Consent

```
GET /api/consent             - –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏—è (—Ç—Ä–µ–±—É–µ—Ç auth)
GET /api/consent/:id         - –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –ø–æ ID (—Ç—Ä–µ–±—É–µ—Ç auth)
```

## üîê Authentication

API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JWT –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º endpoints:

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ:

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π token –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization`:

```bash
curl -H "Authorization: Bearer <your_token>" \
  http://localhost:3000/api/users/profile
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ config/              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (env, db)
‚îú‚îÄ‚îÄ core/                # –ë–∞–∑–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã (BaseRepository, BaseService)
‚îú‚îÄ‚îÄ middleware/          # Middleware (auth, error handling)
‚îú‚îÄ‚îÄ modules/             # –ú–æ–¥—É–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ auth/           # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ users/          # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ leads/          # –õ–∏–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ leadTypes/      # –¢–∏–ø—ã –ª–∏–¥–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ orders/         # –ó–∞–∫–∞–∑—ã
‚îÇ   ‚îú‚îÄ‚îÄ payments/       # –ü–ª–∞—Ç–µ–∂–∏
‚îÇ   ‚îú‚îÄ‚îÄ consent/        # –°–æ–≥–ª–∞—Å–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ audit/          # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ routes/              # –ú–∞—Ä—à—Ä—É—Ç—ã API
‚îú‚îÄ‚îÄ utils/               # –£—Ç–∏–ª–∏—Ç—ã (JWT, password, validation)
‚îú‚îÄ‚îÄ app.ts              # Express –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îî‚îÄ‚îÄ server.ts           # Entry point —Å–µ—Ä–≤–µ—Ä–∞

prisma/
‚îú‚îÄ‚îÄ schema.prisma       # Prisma —Å—Ö–µ–º–∞ –ë–î
‚îî‚îÄ‚îÄ migrations/         # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
```

## üóÑÔ∏è Database Schema

### –¢–∞–±–ª–∏—Ü—ã

- **users** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã (–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, –º–µ–Ω–µ–¥–∂–µ—Ä, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
- **lead_types** - –¢–∏–ø—ã –ª–∏–¥–æ–≤
- **leads_public** - –ü—É–±–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–¥–∞—Ö
- **leads_private** - –ü—Ä–∏–≤–∞—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–¥–∞—Ö (–∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- **consent** - –°–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
- **orders** - –ó–∞–∫–∞–∑—ã/–ø–æ–∫—É–ø–∫–∏ –ª–∏–¥–æ–≤
- **payments** - –ü–ª–∞—Ç–µ–∂–∏
- **audit_log** - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π

## üîÑ –ë–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å—ã

### –ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥

1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ
2. –°–æ–∑–¥–∞–µ—Ç —Ç–∏–ø—ã –ª–∏–¥–æ–≤ (—Ç–æ–≤–∞—Ä—ã)
3. –°–æ–±–∏—Ä–∞–µ—Ç –ª–∏–¥—ã (–∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø—É–±–ª–∏—á–Ω—É—é –∏ –ø—Ä–∏–≤–∞—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)
4. –ü—É–±–ª–∏–∫—É–µ—Ç –ª–∏–¥—ã –≤ –∫–∞—Ç–∞–ª–æ–≥
5. –ü–æ–ª—É—á–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –ª–∏–¥—ã

### –ú–µ–Ω–µ–¥–∂–µ—Ä

1. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ
2. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ –ª–∏–¥–æ–≤
3. –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ –ª–∏–¥–∞
4. –û—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø–ª–∞—Ç–µ–∂
5. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–¥–µ

## üìä –ê—É–¥–∏—Ç

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `audit_log`:

- –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–æ–≤
- –ü–æ–∫—É–ø–∫–∞ –ª–∏–¥–æ–≤
- –£—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- –õ–æ–≥–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üß™ Testing

```bash
npm test
```

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
npm run format        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (Prettier)
npm run lint          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (ESLint)
```

## üö® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∞–º–∏

API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏:

```json
{
  "success": false,
  "error": "Error message",
  "data": null
}
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏–∏ Prisma

–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
npm run prisma:migrate
```

–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ö–µ–º—É –ë–î –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:

```bash
npm run prisma:studio
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —Å bcryptjs
- CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- Rate limiting (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- Connection pooling –≤ PostgreSQL
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–æ–ª—è—Ö
- Pagination –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å)

## üîÆ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] Unit —Ç–µ—Å—Ç—ã
- [ ] Integration —Ç–µ—Å—Ç—ã
- [ ] Rate limiting
- [ ] Redis –∫—ç—à
- [ ] WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
- [ ] GraphQL API
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] Cloud storage –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- [ ] Analytics –∏ reporting

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–æ–±–ª–µ–º —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
